{% extends '../base/base.html' %}
{% load static %}
{% load math_filter %}

{# ---------- Dynamic Title ---------- #}
{% block title %}{{ post.title }} | Dimma Printing{% endblock %}

{# ---------- Dynamic Meta Description ---------- #}
{% block description %}{{ post.excerpt|default_if_none:post.content|truncatewords:25|striptags }}{% endblock %}

{# ---------- Dynamic Meta Keywords ---------- #}
{% block meta_keywords %}
{% for tag in post.tags.all %}{{ tag.name }}{% if not forloop.last %}, {% endif %}{% endfor %}
{% endblock %}

{# ---------- Dynamic Open Graph & Twitter ---------- #}
{% block meta_tags %}
<meta property="og:type" content="article">
<meta property="og:title" content="{{ post.title }}">
<meta property="og:description" content="{{ post.excerpt|default_if_none:post.content|truncatewords:25|striptags }}">
<meta property="og:url" content="{{ request.build_absolute_uri }}">
{% if post.featured_image %}
<meta property="og:image" content="{{ request.build_absolute_uri }}{{ post.featured_image.url }}">
{% endif %}

<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="{{ post.title }}">
<meta name="twitter:description" content="{{ post.excerpt|default_if_none:post.content|truncatewords:25|striptags }}">
{% if post.featured_image %}
<meta name="twitter:image" content="{{ request.build_absolute_uri }}{{ post.featured_image.url }}">
{% endif %}

<link rel="canonical" href="{{ request.build_absolute_uri }}">
{% endblock %}

{# ---------- Dynamic Schema Markup ---------- #}
{% block schema %}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "{{ post.title }}",
  "image": "{% if post.featured_image %}{{ request.build_absolute_uri }}{{ post.featured_image.url }}{% endif %}",
  "author": {
    "@type": "Person",
    "name": "{{ post.author }}"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Dimma Printing"
  },
  "datePublished": "{{ post.publish_date|date:'Y-m-d' }}",
  "description": "{{ post.excerpt|default_if_none:post.content|truncatewords:25|striptags }}"
}
</script>
{% endblock %}

{% block content %}

<link rel="stylesheet" href="{% static 'css/blog-detail.css' %}">
<br><br><br>
<section style="margin:10px; padding: 14px 14px;">
    <!-- Article Header -->
    <article class="blog-post-detail">
        <div class="article-header">
            <div class="container">
                <div class="article-meta">
                    <a href="{% url 'blog:blog' %}" class="back-to-blog">
                        <i class="fas fa-arrow-left"></i> Back to Blog
                    </a>
                    <div class="meta-info">
                        <span class="category-badge">{{ post.category.name|default:"Printing" }}</span>
                        <span class="publish-date">{{ post.publish_date|date:"F j, Y" }}</span>
                        <span class="read-time">‚Ä¢ {{ post.content|wordcount|divide:200 }} min read</span>
                    </div>
                </div>
                
                <h1 class="article-title">{{ post.title }}</h1>
                
                <div class="article-excerpt">
                    <p>{{ post.excerpt|default:post.content|striptags|truncatewords:40 }}</p>
                </div>

                <div class="author-section">
                    <div class="author-avatar">
                        <img src="https://ui-avatars.com/api/?name={{ post.author }}&background=ff3c00&color=fff" alt="{{ post.author }}">
                    </div>
                    <div class="author-info">
                        <span class="author-name">By {{ post.author }}</span>
                        <span class="post-views">{{ post.views }} views</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Featured Image -->
        {% if post.featured_image %}
        <div class="featured-image">
            <div class="container">
                <img src="{{ post.featured_image.url }}" alt="{{ post.title }}" class="article-image">
            </div>
        </div>
        {% endif %}

        <!-- Article Content -->
        <div class="article-content">
            <div class="container">
                <div class="content-grid">
                    <!-- Main Content -->
                    <div class="main-content">
                        <div class="content-wrapper">
                            {{ post.content|safe }}
                        </div>

                        <!-- Tags -->
                        {% if post.tags.all %}
                        <div class="article-tags">
                            <h4>Tags:</h4>
                            <div class="tags-list">
                                {% for tag in post.tags.all %}
                                <a href="{% url 'blog:blog' %}?tag={{ tag.slug }}" class="tag">#{{ tag.name }}</a>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        <!-- Share Buttons -->
                        <div class="share-section">
                            <h4>Share this article:</h4>
                            <div class="share-buttons">
                                <a href="https://twitter.com/intent/tweet?text={{ post.title|urlencode }}&url={{ request.build_absolute_uri|urlencode }}" 
                                class="share-btn twitter" target="_blank">
                                    <i class="fab fa-twitter"></i>
                                </a>
                                <a href="https://www.linkedin.com/sharing/share-offsite/?url={{ request.build_absolute_uri|urlencode }}" 
                                class="share-btn linkedin" target="_blank">
                                    <i class="fab fa-linkedin"></i>
                                </a>
                                <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.build_absolute_uri|urlencode }}" 
                                class="share-btn facebook" target="_blank">
                                    <i class="fab fa-facebook"></i>
                                </a>
                                <button class="share-btn copy-link" onclick="copyToClipboard('{{ request.build_absolute_uri }}')">
                                    <i class="fas fa-link"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Table of Contents -->
                    <aside class="table-of-contents">
                        <div class="toc-header">
                            <h4>Table of Contents</h4>
                        </div>
                        <div class="toc-content" id="tocContent">
                            <!-- Generated dynamically by JavaScript -->
                        </div>
                    </aside>
                </div>
            </div>
        </div>
    </article>
<section>
<!-- Comments Section -->
<section class="comments-section">
    <div class="container">
        <div class="comments-header">
            <h3>Comments ({{ comments.count }})</h3>
        </div>

        <!-- Comment Form -->
        <div class="comment-form-container">
            <h4>Leave a Comment</h4>
            <form method="post" class="comment-form">
                {% csrf_token %}
                <div class="form-grid">
                    <div class="form-group">
                        {{ comment_form.name }}
                        {% if comment_form.name.errors %}
                        <span class="error">{{ comment_form.name.errors }}</span>
                        {% endif %}
                    </div>
                    <div class="form-group">
                        {{ comment_form.email }}
                        {% if comment_form.email.errors %}
                        <span class="error">{{ comment_form.email.errors }}</span>
                        {% endif %}
                    </div>
                </div>
                <div class="form-group">
                    {{ comment_form.comment }}
                    {% if comment_form.comment.errors %}
                    <span class="error">{{ comment_form.comment.errors }}</span>
                    {% endif %}
                </div>
                <button type="submit" class="submit-btn">Post Comment</button>
            </form>
        </div>

        <!-- Comments List -->
        <div class="comments-list">
            {% for comment in comments %}
            <div class="comment" data-scroll>
                <div class="comment-avatar">
                    <img src="https://ui-avatars.com/api/?name={{ comment.name }}&background=ff3c00&color=fff" alt="{{ comment.name }}">
                </div>
                <div class="comment-content">
                    <div class="comment-header">
                        <h5>{{ comment.name }}</h5>
                        <span class="comment-date">{{ comment.created_date|timesince }} ago</span>
                    </div>
                    <p>{{ comment.comment }}</p>
                </div>
            </div>
            {% empty %}
            <div class="no-comments">
                <p>No comments yet. Be the first to share your thoughts!</p>
            </div>
            {% endfor %}
        </div>
    </div>
</section>

<!-- Related Posts Section -->
<section class="related-posts">
    <div class="container">
        <div class="section-header">
            <h3>You might also like</h3>
            <a href="{% url 'blog:blog' %}" class="view-all">View All Posts</a>
        </div>
        <div class="related-grid">
            {% for post in related_posts %}
            <article class="related-post" data-scroll>
                <div class="related-post-image">
                    <img src="{{ post.featured_image.url|default:'https://images.unsplash.com/photo-1499750310107-5fef28a66643?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80' }}" alt="{{ post.title }}">
                    <div class="related-post-category">{{ post.category.name|default:"Printing" }}</div>
                </div>
                <div class="related-post-content">
                    <div class="related-post-meta">
                        <span class="related-post-date">{{ post.publish_date|date:"M d, Y" }}</span>
                        <span class="related-post-views">{{ post.views }} views</span>
                    </div>
                    <h4 class="related-post-title">
                        <a href="{{ post.get_absolute_url }}">{{ post.title|truncatewords:8 }}</a>
                    </h4>
                    <p class="related-post-excerpt" style="color:whitesmoke !important;">{{ post.excerpt|default:post.content|striptags|truncatewords:15 }}</p>
                    <a href="{{ post.get_absolute_url }}" class="related-post-link">
                        Read More <i class="fas fa-arrow-right"></i>
                    </a>
                </div>
            </article>
            {% empty %}
            <div class="no-related-posts">
                <i class="fas fa-newspaper"></i>
                <p>No related posts available</p>
            </div>
            {% endfor %}
        </div>
    </div>
</section>

<style>
/* Related Posts Section */
.related-posts {
    padding: 5rem 0;
    background: var(--darker-bg);
}

.related-posts .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 3rem;
    text-align: left;
}

.related-posts .section-header h3 {
    font-size: 2.2rem;
    color: var(--text);
    font-family: 'Gideon Roman', serif;
    margin: 0;
}

.view-all {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--accent);
    text-decoration: none;
    font-weight: 600;
    transition: var(--transition);
}

.view-all:hover {
    color: #ff521a;
    transform: translateX(5px);
}

.related-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 2rem;
}

.related-post {
    background: var(--card-bg);
    border-radius: 16px;
    overflow: hidden;
    transition: var(--transition);
    opacity: 0;
    transform: translateY(50px);
}

.related-post.is-visible {
    opacity: 1;
    transform: translateY(0);
}

.related-post:hover {
    transform: translateY(-8px);
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
}

.related-post-image {
    position: relative;
    height: 200px;
    overflow: hidden;
}

.related-post-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.5s ease;
}

.related-post:hover .related-post-image img {
    transform: scale(1.1);
}

.related-post-category {
    position: absolute;
    top: 1rem;
    left: 1rem;
    background: var(--accent);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    z-index: 2;
}

.related-post-content {
    padding: 1.5rem;
}

.related-post-meta {
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
    font-size: 0.8rem;
    color: var(--text-secondary);
    flex-wrap: wrap;
}

.related-post-date::before {
    content: 'üìÖ';
    margin-right: 0.3rem;
}

.related-post-views::before {
    content: 'üëÅÔ∏è';
    margin-right: 0.3rem;
}

.related-post-title {
    font-size: 1.2rem;
    margin-bottom: 0.8rem;
    color: var(--text);
    font-family: 'Gideon Roman', serif;
    line-height: 1.4;
}

.related-post-title a {
    color: inherit;
    text-decoration: none;
    transition: color 0.3s ease;
}

.related-post-title a:hover {
    color: var(--accent);
}

.related-post-excerpt {
    color: var(--text-secondary);
    margin-bottom: 1.5rem;
    line-height: 1.6;
    font-size: 0.9rem;
}

.related-post-link {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--accent);
    text-decoration: none;
    font-weight: 600;
    font-size: 0.9rem;
    transition: var(--transition);
}

.related-post-link:hover {
    color: #ff521a;
    transform: translateX(5px);
}

.no-related-posts {
    grid-column: 1 / -1;
    text-align: center;
    padding: 3rem;
    color: var(--text-secondary);
}

.no-related-posts i {
    font-size: 3rem;
    color: var(--accent);
    margin-bottom: 1rem;
    display: block;
}

.no-related-posts p {
    margin: 0;
    font-size: 1.1rem;
}

/* Animation for staggered appearance */
.related-post:nth-child(1) { transition-delay: 0.1s; }
.related-post:nth-child(2) { transition-delay: 0.2s; }
.related-post:nth-child(3) { transition-delay: 0.3s; }
.related-post:nth-child(4) { transition-delay: 0.4s; }

/* Responsive Design */
@media (max-width: 992px) {
    .related-grid {
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.5rem;
    }
    
    .related-posts .section-header {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
    }
}

@media (max-width: 768px) {
    .related-posts {
        padding: 3rem 0;
    }
    
    .related-posts .section-header h3 {
        font-size: 1.8rem;
    }
    
    .related-grid {
        grid-template-columns: 1fr;
        max-width: 500px;
        margin: 0 auto;
    }
    
    .related-post-content {
        padding: 1.25rem;
    }
}

@media (max-width: 576px) {
    .related-posts .section-header h3 {
        font-size: 1.5rem;
    }
    
    .related-post-meta {
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .related-post-title {
        font-size: 1.1rem;
    }
    
    .no-related-posts {
        padding: 2rem 1rem;
    }
    
    .no-related-posts i {
        font-size: 2.5rem;
    }
}

/* Hover effects enhancement */
.related-post {
    position: relative;
}

.related-post::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(255, 60, 0, 0.1) 0%, transparent 50%);
    opacity: 0;
    transition: opacity 0.3s ease;
    pointer-events: none;
    border-radius: 16px;
}

.related-post:hover::before {
    opacity: 1;
}

/* Loading state (if you add AJAX loading later) */
.related-posts.loading .related-grid {
    opacity: 0.6;
    pointer-events: none;
}

.related-posts.loading::after {
    content: 'Loading...';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: var(--accent);
    font-weight: 600;
}
</style>

<script>
// Scroll animation for related posts
document.addEventListener('DOMContentLoaded', function() {
    const relatedPosts = document.querySelectorAll('.related-post');
    
    const elementInView = (el, dividend = 1) => {
        const elementTop = el.getBoundingClientRect().top;
        return (
            elementTop <= (window.innerHeight || document.documentElement.clientHeight) / dividend
        );
    };
    
    const displayScrollElement = (element) => {
        element.classList.add('is-visible');
    };
    
    const handleScrollAnimation = () => {
        relatedPosts.forEach((el, index) => {
            if (elementInView(el, 1.2)) {
                setTimeout(() => {
                    displayScrollElement(el);
                }, index * 150);
            }
        });
    };
    
    // Initial check
    handleScrollAnimation();
    
    // Listen for scroll events
    window.addEventListener('scroll', handleScrollAnimation);
    
    // Optional: Add intersection observer for better performance
    if ('IntersectionObserver' in window) {
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    setTimeout(() => {
                        entry.target.classList.add('is-visible');
                    }, parseInt(entry.target.dataset.delay || 0));
                }
            });
        }, { threshold: 0.1 });
        
        relatedPosts.forEach((post, index) => {
            post.dataset.delay = index * 150;
            observer.observe(post);
        });
    }
});
</script>
<script>
// Table of Contents Generation
        document.addEventListener('DOMContentLoaded', function() {
            // Generate TOC from h2 and h3 elements
            const content = document.querySelector('.content-wrapper');
            const headings = content.querySelectorAll('h2, h3');
            const tocContent = document.getElementById('tocContent');
            
            if (headings.length > 0) {
                let tocHTML = '<ul>';
                
                headings.forEach((heading, index) => {
                    const id = `section-${index}`;
                    heading.id = id;
                    
                    const level = heading.tagName.toLowerCase();
                    const indent = level === 'h3' ? 'style="margin-left: 1rem;"' : '';
                    
                    tocHTML += `
                        <li ${indent}>
                            <a href="#${id}" onclick="scrollToSection('${id}')">
                                ${heading.textContent}
                            </a>
                        </li>
                    `;
                });
                
                tocHTML += '</ul>';
                tocContent.innerHTML = tocHTML;
            } else {
                tocContent.innerHTML = '<p>No sections available</p>';
            }

            // Scroll animation for comments
            const scrollElements = document.querySelectorAll('[data-scroll]');
            
            const elementInView = (el, dividend = 1) => {
                const elementTop = el.getBoundingClientRect().top;
                return elementTop <= (window.innerHeight || document.documentElement.clientHeight) / dividend;
            };
            
            const displayScrollElement = (element) => {
                element.classList.add('is-visible');
            };
            
            const handleScrollAnimation = () => {
                scrollElements.forEach((el) => {
                    if (elementInView(el, 1.2)) {
                        displayScrollElement(el);
                    }
                });
            };
            
            handleScrollAnimation();
            window.addEventListener('scroll', handleScrollAnimation);
        });

        // Smooth scroll to section
        function scrollToSection(id) {
            const element = document.getElementById(id);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // Copy to clipboard
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                const btn = document.querySelector('.copy-link');
                const originalHtml = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i>';
                setTimeout(() => {
                    btn.innerHTML = originalHtml;
                }, 2000);
            });
        }

        // Form styling (since we can't directly style Django form widgets)
        document.addEventListener('DOMContentLoaded', function() {
            const nameInput = document.querySelector('input[name="name"]');
            const emailInput = document.querySelector('input[name="email"]');
            const commentInput = document.querySelector('textarea[name="comment"]');
            
            if (nameInput) {
                nameInput.placeholder = 'Your Name *';
                nameInput.className = 'form-input';
            }
            if (emailInput) {
                emailInput.placeholder = 'Your Email';
                emailInput.className = 'form-input';
            }
            if (commentInput) {
                commentInput.placeholder = 'Your Comment *';
                commentInput.className = 'form-textarea';
            }
        });
</script>


{% endblock content %}